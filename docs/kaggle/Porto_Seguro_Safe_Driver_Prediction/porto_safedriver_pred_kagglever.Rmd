---
title: "Porto Seguro’s Safe Driver Prediction을 통해 Automl h2o 다뤄보기"
author: "최의용"
date: "`r Sys.time()`"
output: 
  html_document:
    highlight: textmate
    theme: simplex
    toc: true
    toc_float: true
    code_folding: show
    df_print: paged
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.align = "center")
```

```{r}
library(readr)
library(tidyverse)
library(ggplot2)
library(dplyr)
library(pROC)
library(h2o)
library(caret)
library(aws.s3)
```

<a style="display:scroll;position:fixed;bottom:10px;right:10px;" href="https://unfinishedgod.github.io/" title=”Home"><img
src="https://img.icons8.com/cute-clipart/80/000000/home.png"></a>


AutoMLh2o를 사용해 캐글의 Porto Seguro’s Safe Driver Prediction를 분석 해보자.




```{r}
h2o.init()
# getwd()

train_set <- read_csv("../input/porto-seguro-safe-driver-prediction/train.csv")
test_set <- read_csv("../input/porto-seguro-safe-driver-prediction/test.csv")

#Setting Missing values to NA. Converting _cat variables to categorical and creating dummy variable for those.
# Set missing values to NA 
train_set[train_set == -1] <- NA
test_set[test_set == -1] <- NA
# collect the categorical variable names
cat_vars <- names(train_set)[grepl('_cat$', names(train_set))]

# convert categorical features to factors
train_set <- train_set %>%
  mutate_at(.vars = cat_vars, .funs = as.factor)

test_set <- test_set %>%
  mutate_at(.vars = cat_vars, .funs = as.factor)

#One hot encode the factor variables
#train_set <- model.matrix(~ . - 1, data = train_set)
```


```{r}
#Splitting Datasets into train and validation. I am taking 75% data. 
#I will use cross validation in next version.
set.seed(32)

# index <- createDataPartition(train_set[,"target"], p = 0.75, list = FALSE)

index <- sample(1:nrow(train_set), nrow(train_set) * 0.7)

tiny_train <- train_set[index, ]
train_val <- train_set[-index, ]

tiny_train.hex  <- as.h2o(tiny_train)
train_val.hex  <- as.h2o(train_val)
test.hex <- as.h2o(test_set)


# rm(train, tiny_train, train_val)
# gc()

# Preparing Target and predictors.
target <- "target"
predictors <- setdiff(names(tiny_train.hex), target)
```


```{r results="hide"}
# Let's run automl now.
automl_h2o_models <- h2o.automl(
  x = predictors, 
  y = target,
  training_frame    = tiny_train.hex,
  leaderboard_frame = train_val.hex,
  max_runtime_secs = 3000
)

automl_leader <- automl_h2o_models@leader
```


```{r}
# Predict on test set
pred_conversion <- h2o.predict(object = automl_leader, newdata = test.hex)

pred_conversion <- as.data.frame(pred_conversion)
Submission <- cbind(test_set$id, pred_conversion)
colnames(Submission) <- c("id", "target")
write.csv(Submission, "Submission_AutoML.csv", row.names = F)

# Any results you write to the current directory are saved as output.
```


